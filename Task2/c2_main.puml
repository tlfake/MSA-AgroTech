@startuml C2_Main_Solution
!define RELATIVE_INCLUDE ../lib
!include ../lib/C4_Container.puml

LAYOUT_WITH_LEGEND()

title Контейнерная диаграмма (C2) — Основное решение: Edge-first архитектура\nПлатформа мониторинга свиноводческих ферм

' === Пользователи ===
Person(operator, "Оператор фермы", "Дежурный сотрудник на ферме")
Person(manager, "Управляющий / Директор", "Контролирует все фермы удалённо")
Person(vet, "Ветеринар", "Отслеживает здоровье животных")

' ================================================================
System_Boundary(farm_agent, "Агент фермы (Edge AI) — один экземпляр на каждую ферму") {

    Container(video_ingestor, "Video Ingestor", "Python / GStreamer", "Получает и буферизует RTSP-потоки\nс камер (в т.ч. ночных). Нарезает\nфреймы для аналитики.")

    Container(ai_engine, "AI Engine", "Python / ONNX Runtime\nTensorRT", "Инференс нейросетевой модели\n(от партнёров) в реальном времени\n(мс). Детекция поведения,\nпересчёт поголовья, здоровье.")

    Container(event_processor, "Event Processor", "Python / Go", "Получает события от AI Engine,\nприменяет правила (порог тревоги),\nформирует алерты. Оповещает\nоператора при офлайне.")

    Container(device_manager, "Device Manager", "Go", "Управляет кормушками, поилками,\nдатчиками разных производителей\nчерез адаптеры (плагины).\nПоддерживает MQTT, Modbus,\nREST API устройств.")

    Container(local_api, "Local API Gateway", "Go / Nginx", "REST + WebSocket API для\nлокального веб-интерфейса\nоператора. Работает без\nинтернета. JWT-авторизация.")

    ContainerDb(local_db, "Local Database", "PostgreSQL", "Хранит события, алерты,\nметрики, состояние поголовья,\nконфигурацию устройств.\nРаботает автономно.")

    ContainerDb(local_buffer, "Sync Buffer", "SQLite / WAL", "Буферизует данные для\nотправки на центральный\nсервер. Гарантирует доставку\nпосле восстановления связи.")

    Container(local_broker, "Local Broker", "RabbitMQ", "Внутренняя шина событий\nна ферме. Развязывает\nкомпоненты. Поддерживает MQTT\nдля IoT-устройств.")

    Container(sync_agent, "Sync Agent", "Go", "Периодически (или по расписанию)\nсинхронизирует данные с\nцентральным сервером.\nBatch-отправка с retry и\nback-off при проблемах со связью.")

    Container(local_notifier, "Local Notifier", "Python", "Локальные уведомления оператору\nпри офлайне: SMS (GSM-модем),\nзвуковой сигнал, push на\nлокальный веб-интерфейс.")
}

' ================================================================
System_Boundary(central, "Центральный сервер мониторинга") {

    Container(api_gateway, "API Gateway", "Kong / Nginx", "Единая точка входа для\nвнешних клиентов и агентов.\nAутентификация (OAuth2/OIDC),\nrouting, rate-limiting, TLS.")

    Container(auth_service, "Auth Service", "Go / Keycloak", "IAM: управление \nпользователями и ролями\n(оператор, ветеринар, директор).\nOAuth2 / OpenID Connect.")

    Container(farm_service, "Farm Service", "Go", "Управление данными ферм:\nсписок, статус, конфигурация,\nсобытия, метрики. Получает\nданные от Sync Agent агентов.")

    Container(alert_service, "Alert Service", "Go", "Агрегация и маршрутизация\nалертов со всех ферм.\nПравила эскалации.\nОтправка уведомлений.")

    Container(analytics_service, "Analytics Service", "Python / FastAPI", "Сводная аналитика:\nтренды, прогноз расхода корма,\nдинамика поголовья. HTTP API\nдля дашборда.")

    Container(web_portal, "Web Portal", "React / TypeScript", "SPA для управляющих\nи ветеринаров. Показывает\nдашборды, алерты, историю,\nвидео (когда связь есть).")

    Container(notification_service, "Notification Service", "Go", "Отправка уведомлений:\nPush, Email, SMS для\nвсех ролей. Роутинг\nпо подписке пользователей.")

    Container(sync_receiver, "Sync Receiver", "Go", "Принимает batch-данные\nот агентов ферм.\nДедупликация, валидация,\nзапись в хранилища.")

    Container(metrics_service, "Metrics Service", "Go / Prometheus", "Агрегация метрик\nсо всех ферм.\nPrometheus-эндпоинты.\nПоддержка кастомных метрик.")

    ContainerDb(central_db, "Central Database", "PostgreSQL", "Структурированные данные:\nфермы, пользователи, события,\nалерты, настройки, поголовье.")

    ContainerDb(timeseries_db, "Time Series DB", "TimescaleDB", "Временные ряды:\nметрики датчиков, видеособытия,\nпараметры среды. Хранение\nи быстрые запросы по времени.")
}

' ================================================================
System_Ext(agrotech, "АгроПром Х (ERP / DWH / BI)", "Существующая платформа компании")
System_Ext(ext_notifications, "Внешние каналы уведомлений", "SMS-шлюз, Firebase Push, SMTP")
System_Ext(iot_hw, "IoT-оборудование фермы", "Камеры, датчики, кормушки, поилки")

' ================================================================
' Связи: оператор ↔ ферма
Rel(operator, local_api, "Управляет оборудованием,\nпросматривает события", "HTTPS / WebSocket")

' Внутри агента фермы
Rel(iot_hw, video_ingestor, "RTSP видеопотоки", "RTSP / H.264")
Rel(iot_hw, device_manager, "Данные датчиков,\nприём команд", "MQTT / Modbus / REST")
Rel(video_ingestor, local_broker, "Фреймы видео", "AMQP")
Rel(local_broker, ai_engine, "Фреймы для инференса", "AMQP")
Rel(ai_engine, local_broker, "События детекции", "AMQP")
Rel(local_broker, event_processor, "События детекции", "AMQP")
Rel(device_manager, local_broker, "Данные с датчиков", "AMQP")
Rel(event_processor, local_db, "Сохранение событий\nи алертов", "SQL")
Rel(event_processor, local_notifier, "Запуск оповещения\nпри алерте", "Internal API")
Rel(event_processor, local_buffer, "Буферизация для\nсинхронизации", "SQL")
Rel(local_api, local_db, "Чтение данных\nдля оператора", "SQL")
Rel(local_api, event_processor, "Команды управления", "Internal API")
Rel(local_api, device_manager, "Команды устройствам", "Internal API")
Rel(sync_agent, local_buffer, "Читает буферизованные\nданные", "SQL")

' Агент ↔ центр
Rel(sync_agent, sync_receiver, "Batch-синхронизация данных\n(до 10 мин задержки)", "HTTPS REST / TLS")

' Центральный сервер — внутренние связи
Rel(manager, web_portal, "Мониторинг ферм,\nотчёты, управление", "HTTPS")
Rel(vet, web_portal, "Просмотр состояния\nживотных, алерты", "HTTPS")
Rel(web_portal, api_gateway, "API-запросы", "HTTPS / REST")
Rel(api_gateway, auth_service, "Проверка токенов", "Internal HTTP")
Rel(api_gateway, farm_service, "Данные ферм", "Internal HTTP")
Rel(api_gateway, alert_service, "Алерты", "Internal HTTP")
Rel(api_gateway, analytics_service, "Аналитика", "Internal HTTP")
Rel(api_gateway, metrics_service, "Метрики", "Internal HTTP")
Rel(sync_receiver, central_db, "Запись событий\nи данных ферм", "SQL")
Rel(sync_receiver, timeseries_db, "Запись временных рядов\nметрик и событий", "SQL")
Rel(farm_service, central_db, "Чтение/запись данных ферм", "SQL")
Rel(alert_service, central_db, "Алерты и правила", "SQL")
Rel(alert_service, notification_service, "Отправка уведомлений", "Internal HTTP")
Rel(analytics_service, timeseries_db, "Аналитические запросы", "SQL")
Rel(analytics_service, central_db, "Данные ферм и поголовья", "SQL")
Rel(metrics_service, timeseries_db, "Метрики для агрегации", "SQL")
Rel(notification_service, ext_notifications, "Push, Email, SMS", "HTTPS API / SMTP")
Rel(farm_service, agrotech, "Передача данных в ERP/DWH", "REST API / ETL")

@enduml
